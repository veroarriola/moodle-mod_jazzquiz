/**
 * @package   mod_jazzquiz
 * @author    Sebastian S. Gundersen <sebastsg@stud.ntnu.no>
 * @copyright 2014 University of Wisconsin - Madison
 * @copyright 2018 NTNU
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_jazzquiz/instructor",["jquery","mod_jazzquiz/core"],(function($,Jazz){const Quiz=Jazz.Quiz,Question=Jazz.Question,Ajax=Jazz.Ajax,setText=Jazz.setText;class ResponseView{constructor(quiz){this.quiz=quiz,this.currentResponses=[],this.showVotesUponReview=!1,this.respondedCount=0,this.showResponses=!1,this.totalStudents=0,$(document).on("click","#jazzquiz_undo_merge",(()=>this.undoMerge())),$(document).on("click",(event=>{event.target.classList.contains("bar")?this.startMerge(event.target.id):event.target.parentNode&&event.target.parentNode.classList.contains("bar")&&this.startMerge(event.target.parentNode.id)})),$(document).on("click","#review_show_normal_results",(()=>this.refresh(!1))),$(document).on("click","#review_show_vote_results",(()=>this.refreshVotes()))}clear(){Quiz.responses.html(""),Quiz.responseInfo.html("")}hide(){Quiz.uncheck(Instructor.control("responses")),Quiz.hide(Quiz.responses),Quiz.hide(Quiz.responseInfo)}show(){Quiz.check(Instructor.control("responses")),Quiz.show(Quiz.responses),Quiz.show(Quiz.responseInfo),this.showVotesUponReview?(this.refreshVotes(),this.showVotesUponReview=!1):this.refresh(!1)}toggle(){this.showResponses=!this.showResponses,this.showResponses?this.show():this.hide()}endMerge(){$(".merge-into").removeClass("merge-into"),$(".merge-from").removeClass("merge-from")}undoMerge(){Ajax.post("undo_merge",{},(()=>this.refresh(!0)))}merge(from,into){Ajax.post("merge_responses",{from:from,into:into},(()=>this.refresh(!1)))}startMerge(fromRowBarId){const $barCell=$("#"+fromRowBarId);let $row=$barCell.parent();if($row.hasClass("merge-from"))this.endMerge();else{if($row.hasClass("merge-into")){const $fromRow=$(".merge-from");return this.merge($fromRow.data("response"),$row.data("response")),void this.endMerge()}$row.addClass("merge-from"),$row.parent().parent().find("tr").each((function(){$(this).find("td")[1].id!==$barCell.attr("id")&&$(this).addClass("merge-into")}))}}createControls(name){if(this.quiz.question.hasVotes){if("reviewing"===this.quiz.state){let $showNormalResult=$("#review_show_normal_results"),$showVoteResult=$("#review_show_vote_results");Quiz.show(Quiz.responseInfo),"vote_response"===name?0===$showNormalResult.length&&(setText(Quiz.responseInfo.html('<h4 class="inline"></h4>').children("h4"),"showing_vote_results"),Quiz.responseInfo.append('<button id="review_show_normal_results" class="btn btn-primary"></button><br>'),setText($("#review_show_normal_results"),"click_to_show_original_results"),$showVoteResult.remove()):"current_response"===name&&0===$showVoteResult.length&&(setText(Quiz.responseInfo.html('<h4 class="inline"></h4>').children("h4"),"showing_original_results"),Quiz.responseInfo.append('<button id="review_show_vote_results" class="btn btn-primary"></button><br>'),setText($("#review_show_vote_results"),"click_to_show_vote_results"),$showNormalResult.remove())}}else Quiz.hide(Quiz.responseInfo)}createBarGraph(responses,name,targetId,graphId,rebuild){let target=document.getElementById(targetId);if(null===target)return;let total=0,highestResponseCount=0;for(let i=0;i<responses.length;i++){let count=parseInt(responses[i].count);total+=count,count>highestResponseCount&&(highestResponseCount=count)}0===total&&(total=1),rebuild&&(target.innerHTML="");for(let i=0;i<target.rows.length;i++){let prune=!0;for(let j=0;j<responses.length;j++)if(target.rows[i].dataset.response===responses[j].response){prune=!1;break}prune&&(target.deleteRow(i),i--)}this.createControls(name),name+=graphId;for(let i=0;i<responses.length;i++){const percent=parseInt(responses[i].count)/highestResponseCount*100;let rowIndex=-1,currentRowIndex=-1;for(let j=0;j<target.rows.length;j++)if(target.rows[j].dataset.response===responses[i].response){rowIndex=target.rows[j].dataset.row_i,currentRowIndex=j;break}if(-1===rowIndex){rowIndex=target.rows.length;let row=target.insertRow();row.dataset.response_i=i,row.dataset.response=responses[i].response,row.dataset.percent=percent,row.dataset.row_i=rowIndex,row.dataset.count=responses[i].count,row.classList.add("selected-vote-option"),percent<15&&row.classList.add("outside");const countHtml='<span id="'+name+"_count_"+rowIndex+'">'+responses[i].count+"</span>";let responseCell=row.insertCell(0);responseCell.onclick=function(){$(this).parent().toggleClass("selected-vote-option")};let barCell=row.insertCell(1);barCell.classList.add("bar"),barCell.id=name+"_bar_"+rowIndex,barCell.innerHTML='<div style="width:'+percent+'%;">'+countHtml+"</div>";const latexId=name+"_latex_"+rowIndex;responseCell.innerHTML='<span id="'+latexId+'"></span>',Quiz.addMathjaxElement($("#"+latexId),responses[i].response),"stack"===responses[i].qtype&&Quiz.renderMaximaEquation(responses[i].response,latexId)}else{let currentRow=target.rows[currentRowIndex];currentRow.dataset.row_i=rowIndex,currentRow.dataset.response_i=i,currentRow.dataset.percent=percent,currentRow.dataset.count=responses[i].count;const containsOutside=currentRow.classList.contains("outside");percent>15&&containsOutside?currentRow.classList.remove("outside"):percent<15&&!containsOutside&&currentRow.classList.add("outside");let countElement=document.getElementById(name+"_count_"+rowIndex);null!==countElement&&(countElement.innerHTML=responses[i].count);let barElement=document.getElementById(name+"_bar_"+rowIndex);null!==barElement&&(barElement.firstElementChild.style.width=percent+"%")}}}static sortBarGraph(targetId){let target=document.getElementById(targetId);if(null===target)return;let isSorting=!0;for(;isSorting;){isSorting=!1;for(let i=0;i<target.rows.length-1;i++){if(parseInt(target.rows[i].dataset.percent)<parseInt(target.rows[i+1].dataset.percent)){target.rows[i].parentNode.insertBefore(target.rows[i+1],target.rows[i]),isSorting=!0;break}}}}set(wrapperId,tableId,responses,responded,questionType,graphId,rebuild){if(void 0!==responses){if(0===responses.length)return Quiz.show(Quiz.responded),void setText(Quiz.responded.find("h4"),"a_out_of_b_responded","jazzquiz",{a:0,b:this.totalStudents});switch(questionType){case"shortanswer":for(let i=0;i<responses.length;i++)responses[i].response=responses[i].response.trim();break;case"stack":for(let i=0;i<responses.length;i++)responses[i].response=responses[i].response.replace(/\s/g,"")}this.currentResponses=[],this.respondedCount=0;for(let i=0;i<responses.length;i++){let exists=!1,count=1;void 0!==responses[i].count&&(count=parseInt(responses[i].count)),this.respondedCount+=count;for(let j=0;j<this.currentResponses.length;j++)if(this.currentResponses[j].response===responses[i].response){this.currentResponses[j].count+=count,exists=!0;break}exists||this.currentResponses.push({response:responses[i].response,count:count,qtype:questionType})}if(0!==Quiz.responded.length&&void 0!==responded&&(Quiz.show(Quiz.responded),setText(Quiz.responded.find("h4"),"a_out_of_b_responded","jazzquiz",{a:responded,b:this.totalStudents})),!this.showResponses&&"reviewing"!==this.quiz.state)return Quiz.hide(Quiz.responseInfo),void Quiz.hide(Quiz.responses);if(null===document.getElementById(tableId)){const html='<table id="'+tableId+'" class="jazzquiz-responses-overview"></table>';Quiz.show($("#"+wrapperId).html(html))}this.createBarGraph(this.currentResponses,"current_response",tableId,graphId,rebuild),ResponseView.sortBarGraph(tableId)}}refresh(rebuild){Ajax.get("get_results",{},(data=>{this.quiz.question.hasVotes=data.has_votes,this.totalStudents=parseInt(data.total_students),this.set("jazzquiz_responses_container","current_responses_wrapper",data.responses,data.responded,data.question_type,"results",rebuild),data.merge_count>0?Quiz.show($("#jazzquiz_undo_merge")):Quiz.hide($("#jazzquiz_undo_merge"))}))}refreshVotes(){if(!this.showResponses&&"reviewing"!==this.quiz.state)return Quiz.hide(Quiz.responseInfo),void Quiz.hide(Quiz.responses);Ajax.get("get_vote_results",{},(data=>{const answers=data.answers,targetId="wrapper_vote_responses";let responses=[];this.respondedCount=0,this.totalStudents=parseInt(data.total_students);for(let i in answers)answers.hasOwnProperty(i)&&(responses.push({response:answers[i].attempt,count:answers[i].finalcount,qtype:answers[i].qtype,slot:answers[i].slot}),this.respondedCount+=parseInt(answers[i].finalcount));if(setText(Quiz.responded.find("h4"),"a_out_of_b_voted","jazzquiz",{a:this.respondedCount,b:this.totalStudents}),null===document.getElementById(targetId)){const html='<table id="'+targetId+'" class="jazzquiz-responses-overview"></table>';Quiz.show(Quiz.responses.html(html))}this.createBarGraph(responses,"vote_response",targetId,"vote",!1),ResponseView.sortBarGraph(targetId)}))}}class Instructor{constructor(quiz){this.quiz=quiz,this.responses=new ResponseView(quiz),this.isShowingCorrectAnswer=!1,this.totalQuestions=0,this.allowVote=!1,$(document).on("keyup",(event=>{27===event.keyCode&&Instructor.closeFullscreenView()})),$(document).on("click",(event=>{Instructor.closeQuestionListMenu(event,"improvise"),Instructor.closeQuestionListMenu(event,"jump")})),Instructor.addEvents({repoll:()=>this.repollQuestion(),vote:()=>this.runVoting(),improvise:()=>this.showQuestionListSetup("improvise"),jump:()=>this.showQuestionListSetup("jump"),next:()=>this.nextQuestion(),random:()=>this.randomQuestion(),end:()=>this.endQuestion(),fullscreen:()=>Instructor.showFullscreenView(),answer:()=>this.showCorrectAnswer(),responses:()=>this.responses.toggle(),exit:()=>this.closeSession(),quit:()=>this.closeSession(),startquiz:()=>this.startQuiz()}),Instructor.addHotkeys({t:"responses",r:"repoll",a:"answer",e:"end",j:"jump",i:"improvise",v:"vote",n:"next",m:"random",f:"fullscreen"})}static addHotkeys(keys){for(let key in keys)keys.hasOwnProperty(key)&&(keys[key]={action:keys[key],repeat:!1},$(document).on("keydown",(event=>{if(keys[key].repeat||event.ctrlKey)return;if(String.fromCharCode(event.which).toLowerCase()!==key)return;let focusedTag=$(":focus").prop("tagName");if(void 0!==focusedTag&&(focusedTag=focusedTag.toLowerCase(),"input"===focusedTag||"textarea"===focusedTag))return;event.preventDefault(),keys[key].repeat=!0;let $control=Instructor.control(keys[key].action);$control.length&&!$control.prop("disabled")&&$control.click()})),$(document).on("keyup",(event=>{String.fromCharCode(event.which).toLowerCase()===key&&(keys[key].repeat=!1)})))}static addEvents(events){for(let key in events)events.hasOwnProperty(key)&&$(document).on("click","#jazzquiz_control_"+key,(()=>{Instructor.enableControls([]),events[key]()}))}static get controls(){return $("#jazzquiz_controls_box")}static get controlButtons(){return Instructor.controls.find(".quiz-control-buttons")}static control(key){return $("#jazzquiz_control_"+key)}static get side(){return $("#jazzquiz_side_container")}static get correctAnswer(){return $("#jazzquiz_correct_answer_container")}static get isMerging(){return 0!==$(".merge-from").length}onNotRunning(data){this.responses.totalStudents=data.student_count,Quiz.hide(Instructor.side),setText(Quiz.info,"instructions_for_instructor"),Instructor.enableControls([]),Quiz.hide(Instructor.controlButtons);let $studentsJoined=Instructor.control("startquiz").next();1===data.student_count?setText($studentsJoined,"one_student_has_joined"):data.student_count>1?setText($studentsJoined,"x_students_have_joined","jazzquiz",data.student_count):setText($studentsJoined,"no_students_have_joined"),Quiz.show(Instructor.control("startquiz").parent())}onPreparing(data){Quiz.hide(Instructor.side),setText(Quiz.info,"instructions_for_instructor");let enabledButtons=["improvise","jump","random","fullscreen","quit"];data.slot<this.totalQuestions&&enabledButtons.push("next"),Instructor.enableControls(enabledButtons)}onRunning(data){if(this.responses.showResponses||this.responses.hide(),Quiz.show(Instructor.side),Instructor.enableControls(["end","responses","fullscreen"]),this.quiz.question.questionTime=data.questiontime,this.quiz.question.isRunning)data.questionTime>0&&data.delay<-data.questiontime&&this.endQuestion(),this.responses.refresh(!Instructor.isMerging);else{this.quiz.question.startCountdown(data.questiontime,data.delay)&&(this.quiz.question.isRunning=!0)}}onReviewing(data){Quiz.show(Instructor.side);let enabledButtons=["answer","repoll","fullscreen","improvise","jump","random","quit"];this.allowVote&&enabledButtons.push("vote"),data.slot<this.totalQuestions&&enabledButtons.push("next"),Instructor.enableControls(enabledButtons),Question.isLoaded()||this.quiz.question.refresh(),this.quiz.isNewState&&this.responses.show(),this.quiz.question.isRunning=!1}onSessionClosed(data){Quiz.hide(Instructor.side),Quiz.hide(Instructor.correctAnswer),Instructor.enableControls([]),this.responses.clear(),this.quiz.question.isRunning=!1}onVoting(data){this.responses.showResponses||this.responses.hide(),Quiz.show(Instructor.side),Instructor.enableControls(["quit","fullscreen","answer","responses","end"]),this.responses.refreshVotes()}onStateChange(state){$("#region-main").find("ul.nav.nav-tabs").css("display","none"),$("#region-main-settings-menu").css("display","none"),$(".region_main_settings_menu_proxy").css("display","none"),Quiz.show(Instructor.controlButtons),Quiz.hide(Instructor.control("startquiz").parent())}onQuestionRefreshed(data){this.allowVote=data.voteable}onTimerEnding(){this.endQuestion()}onTimerTick(timeLeft){setText(Question.timer,"x_seconds_left","jazzquiz",timeLeft)}startQuiz(){Quiz.hide(Instructor.control("startquiz").parent()),Ajax.post("start_quiz",{},(()=>$("#jazzquiz_controls").removeClass("btn-hide")))}endQuestion(){this.quiz.question.hideTimer(),Ajax.post("end_question",{},(()=>{"voting"===this.quiz.state?this.responses.showVotesUponReview=!0:(this.quiz.question.isRunning=!1,Instructor.enableControls([]))}))}showQuestionListSetup(name){let $controlButton=Instructor.control(name);$controlButton.hasClass("active")||Ajax.get("list_"+name+"_questions",{},(data=>{let self=this,$menu=$("#jazzquiz_"+name+"_menu");const menuMargin=$controlButton.offset().left-$controlButton.parent().offset().left;$menu.html("").addClass("active").css("margin-left",menuMargin+"px"),$controlButton.addClass("active");const questions=data.questions;for(let i in questions){if(!questions.hasOwnProperty(i))continue;let $questionButton=$('<button class="btn"></button>');Quiz.addMathjaxElement($questionButton,questions[i].name),$questionButton.data({time:questions[i].time,"question-id":questions[i].questionid,"jazzquiz-question-id":questions[i].jazzquizquestionid}),$questionButton.data("test",1),$questionButton.on("click",(function(){const questionId=$(this).data("question-id"),time=$(this).data("time"),jazzQuestionId=$(this).data("jazzquiz-question-id");self.jumpQuestion(questionId,time,jazzQuestionId),$menu.html("").removeClass("active"),$controlButton.removeClass("active")})),$menu.append($questionButton)}}))}static getSelectedAnswersForVote(){let result=[];return $(".selected-vote-option").each(((i,option)=>{result.push({text:option.dataset.response,count:option.dataset.count})})),result}runVoting(){const options=Instructor.getSelectedAnswersForVote(),data={questions:encodeURIComponent(JSON.stringify(options))};Ajax.post("run_voting",data,(()=>{}))}startQuestion(method,questionId,questionTime,jazzquizQuestionId){Quiz.hide(Quiz.info),this.responses.clear(),this.hideCorrectAnswer(),Ajax.post("start_question",{method:method,questionid:questionId,questiontime:questionTime,jazzquizquestionid:jazzquizQuestionId},(data=>this.quiz.question.startCountdown(data.questiontime,data.delay)))}jumpQuestion(questionId,questionTime,jazzquizQuestionId){this.startQuestion("jump",questionId,questionTime,jazzquizQuestionId)}repollQuestion(){this.startQuestion("repoll",0,0,0)}nextQuestion(){this.startQuestion("next",0,0,0)}randomQuestion(){this.startQuestion("random",0,0,0)}closeSession(){Quiz.hide($("#jazzquiz_undo_merge")),Quiz.hide(Question.box),Quiz.hide(Instructor.controls),setText(Quiz.info,"closing_session"),Ajax.post("close_session",{},(()=>window.location=location.href.split("&")[0]))}hideCorrectAnswer(){this.isShowingCorrectAnswer&&(Quiz.hide(Instructor.correctAnswer),Quiz.uncheck(Instructor.control("answer")),this.isShowingCorrectAnswer=!1)}showCorrectAnswer(){this.hideCorrectAnswer(),Ajax.get("get_right_response",{},(data=>{Quiz.show(Instructor.correctAnswer.html(data.right_answer)),Quiz.renderAllMathjax(),Quiz.check(Instructor.control("answer")),this.isShowingCorrectAnswer=!0}))}static enableControls(buttons){Instructor.controlButtons.children("button").each(((index,child)=>{const id=child.getAttribute("id").replace("jazzquiz_control_","");child.disabled=-1===buttons.indexOf(id)}))}static showFullscreenView(){Quiz.main.hasClass("jazzquiz-fullscreen")?Instructor.closeFullscreenView():(document.documentElement.style.overflowY="hidden",Quiz.main.addClass("jazzquiz-fullscreen"))}static closeFullscreenView(){document.documentElement.style.overflowY="auto",Quiz.main.removeClass("jazzquiz-fullscreen")}static closeQuestionListMenu(event,name){const menuId="#jazzquiz_"+name+"_menu";$(event.target).closest(menuId).length||($(menuId).html("").removeClass("active"),Instructor.control(name).removeClass("active"))}static addReportEventHandlers(){$(document).on("click","#report_overview_controls button",(function(){const action=$(this).data("action");"attendance"===action?($("#report_overview_responded").fadeIn(),$("#report_overview_responses").fadeOut()):"responses"===action&&($("#report_overview_responses").fadeIn(),$("#report_overview_responded").fadeOut())}))}}return{initialize:function(totalQuestions,reportView,slots){let quiz=new Quiz(Instructor);quiz.role.totalQuestions=totalQuestions,reportView?(Instructor.addReportEventHandlers(),quiz.role.responses.showResponses=!0,slots.forEach((slot=>{const wrapper="jazzquiz_wrapper_responses_"+slot.num,table="responses_wrapper_table_"+slot.num,graph="report_"+slot.num;quiz.role.responses.set(wrapper,table,slot.responses,void 0,slot.type,graph,!1)}))):quiz.poll(500)}}}));

//# sourceMappingURL=instructor.min.js.map